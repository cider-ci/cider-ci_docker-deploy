- name: set :aot :all
  lineinfile:
    dest: '{{service_dir}}/project.clj'
    regexp: '^\s+:aot\s+.*'
    line: '  :aot :all'

- name: lein_jar
  shell: |
    set -eux
    cd {{service_dir}}
    export LEIN_ROOT=yes
    lein do install
  register: lein_jar_cmd_res

- name: jar path
  shell: echo '{{lein_jar_cmd_res.stdout}}' | grep Created | cut -d " " -f 2  | xargs
  register: jar_path_cmd_res

- name: lein cp
  shell: |
    set -eux
    cd {{service_dir}}
    export LEIN_ROOT=yes
    lein with-profile production cp
  register: lein_cp_cmd_res

- name: classpath
  classpath:
    lein_cp: "{{lein_cp_cmd_res.stdout}}"
    jar_path: "{{jar_path_cmd_res.stdout}}"
    service_dir: "{{service_dir}}"
    server_dir: "{{server_dir}}"
  register: classpath_cmd_res

- set_fact:
    classpath: "{{classpath_cmd_res.classpath}}"

- template:
    src: run_lein-service.sh
    dest: /usr/local/bin/cider-ci_{{service.name}}
    mode: u=rwx,g=rx,o=rx
